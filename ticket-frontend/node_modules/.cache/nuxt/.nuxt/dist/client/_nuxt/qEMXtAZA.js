import{_ as I}from"./D3QffkNq.js";import{_ as A}from"./CFZJElYW.js";import{a0 as B}from"./GPD3P-m0.js";import{_ as N}from"./RuDiqTgZ.js";import{Y as h,g as R,z as _,e as b,h as q,l as E,a2 as z,k as F,o as d,w as v,a as u,c as m,F as P,q as L,t as y,b as p,p as O,d as U}from"./BGim2kwq.js";const D=async l=>{if(!l)throw new Error("Ticket id is required");let c=h("auth_token").value||"";try{c=decodeURIComponent(c)}catch{}const a=`http://localhost:8000/api/tickets/${encodeURIComponent(l)}/comments`,s=await fetch(a,{method:"GET",headers:{Accept:"application/json",Authorization:`Bearer ${c}`}}),t=await s.json();if(!s.ok)throw t;return t.data??t},G=async(l,i)=>{if(!l)throw new Error("Ticket id is required");if(!i)throw new Error("Comment payload is required");let a=h("auth_token").value||"";try{a=decodeURIComponent(a)}catch{}const s=`http://localhost:8000/api/tickets/${encodeURIComponent(l)}/comments`,t=await fetch(s,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(i)}),n=await t.json();if(!t.ok)throw n;return n.data??n},J={class:"p-4"},M={class:"space-y-3"},W={key:0,class:"text-sm text-gray-500"},Y={key:1},H={class:"space-y-3 max-h-80 overflow-y-auto pr-2"},K={key:0,class:"text-sm text-gray-500"},Q={key:1,class:"space-y-3"},X={class:"text-sm text-gray-800 whitespace-pre-line"},Z={class:"text-xs text-gray-400 mt-1"},ee={class:"pt-2"},te={key:0,class:"mt-2"},oe={class:"flex justify-end gap-2 mt-2"},ae=R({__name:"TicketComments",props:{ticketId:{type:[String,Number],required:!0}},setup(l){const i=l,c=_([]),a=_(!1),s=_(""),t=_(!1),n=_(!0),x=h("user_role"),S=b(()=>String(x?.value||"").toLowerCase()),V=b(()=>["supervisor","technician"].includes(S.value)),k=async()=>{if(i.ticketId){a.value=!0;try{const r=await D(String(i.ticketId));c.value=Array.isArray(r)?r:r?.data||[]}catch(r){console.error("Failed to load comments",r)}finally{a.value=!1}}},T=async()=>{if(!(!s.value||t.value)){t.value=!0;try{const r={content:s.value,is_user_visible:!!n.value},e=await G(String(i.ticketId),r),f=e?.data?e.data:e;f&&c.value.unshift(f),s.value="",n.value=!0}catch(r){console.error("Failed to post comment",r)}finally{t.value=!1}}},w=r=>new Date(r).toLocaleString();return q(k),E(()=>i.ticketId,()=>k()),(r,e)=>{const f=I,C=z("UFormGroup"),$=A,g=B,j=N;return d(),F(j,{class:"mt-4"},{default:v(()=>[u("div",J,[e[5]||(e[5]=u("h3",{class:"text-lg font-semibold mb-3"},"Comments",-1)),u("div",M,[a.value?(d(),m("div",W,"Loading comments...")):(d(),m("div",Y,[u("div",H,[c.value.length?(d(),m("div",Q,[(d(!0),m(P,null,L(c.value,o=>(d(),m("div",{key:o.id,class:"p-3 border rounded"},[u("div",X,y(o.content),1),u("div",Z,"by "+y(o.user_id?`User #${o.username}`:o.user?.name||"Unknown")+" â€¢ "+y(o.created_at?w(o.created_at):o.updated_at?w(o.updated_at):""),1)]))),128))])):(d(),m("div",K,"No comments yet"))])])),u("div",ee,[p(C,{label:"Add comment",name:"comment"},{default:v(()=>[p(f,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=o=>s.value=o),placeholder:"Write a comment..."},null,8,["modelValue"])]),_:1}),V.value?(d(),m("div",te,[p(C,{label:"Visibility",name:"visibility"},{default:v(()=>[p($,{modelValue:n.value,"onUpdate:modelValue":e[1]||(e[1]=o=>n.value=o),items:[{label:"Public",value:!0},{label:"Private",value:!1}]},null,8,["modelValue"])]),_:1})])):O("",!0),u("div",oe,[p(g,{size:"sm",color:"neutral",variant:"ghost",onClick:e[2]||(e[2]=o=>s.value="")},{default:v(()=>[...e[3]||(e[3]=[U("Cancel",-1)])]),_:1}),p(g,{size:"sm",color:"primary",loading:t.value,onClick:T},{default:v(()=>[...e[4]||(e[4]=[U("Post",-1)])]),_:1},8,["loading"])])])])])]),_:1})}}}),ce=Object.assign(ae,{__name:"TicketComments"}),de=async(l,i)=>{if(!l)throw new Error("Ticket id is required");if(!i)throw new Error("Status is required");let a=h("auth_token").value||"";try{a=decodeURIComponent(a)}catch{}const s=`http://localhost:8000/api/tickets/${encodeURIComponent(l)}/status`,t=await fetch(s,{method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({status:i})}),n=await t.json();if(!t.ok)throw n;return n?.data?n.data:n};export{ce as _,de as u};
