import{s as me,_ as _e,a as he,b as ve,c as ge,i as fe}from"./Ddr_hDuZ.js";import{a0 as ye}from"./GPD3P-m0.js";import{_ as xe}from"./CFZJElYW.js";import{_ as ke}from"./RuDiqTgZ.js";import{_ as be}from"./3Xv3klxV.js";import{g as we}from"./B6rNHc4N.js";import{_ as Ce,u as Te}from"./qEMXtAZA.js";import{b as $e}from"./BbY_nosd.js";import{Y as X,g as Ue,a3 as Ae,e as A,z as f,P as Ie,$ as K,h as Se,j as je,a5 as De,a1 as Ne,l as Pe,k as Q,w as u,a2 as R,o as v,b as o,a as n,p as N,f as s,d as b,t as r,c as y,F as W,L as Be,H as Fe,q as Ve}from"./BGim2kwq.js";import{u as Y}from"./RmwAmyau.js";import"./kDLvYEi9.js";import"./K8s1tnq0.js";import"./CCraGg39.js";import"./D3QffkNq.js";const ze=async(C,m)=>{if(!C)throw new Error("Ticket id is required");let x=X("auth_token").value||"";try{x=decodeURIComponent(x)}catch{}const l=`http://localhost:8000/api/tickets/${encodeURIComponent(C)}/assign`,d=await fetch(l,{method:"PATCH",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${x}`},body:JSON.stringify({technician_id:m})}),c=await d.json();if(!d.ok)throw c;return c?.data?c.data:c},Ee=async(C,m)=>{if(!C)throw new Error("Ticket id is required");let x=X("auth_token").value||"";try{x=decodeURIComponent(x)}catch{}const l=`http://localhost:8000/api/tickets/${encodeURIComponent(C)}/reassign`,d=await fetch(l,{method:"PATCH",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${x}`},body:JSON.stringify({assigned_tech_id:m})}),c=await d.json();if(!d.ok)throw c;return c?.data?c.data:c},Re={class:"flex flex-col flex-1 min-h-0 gap-6 p-6"},We={class:"flex items-center justify-between gap-3"},He={class:"flex gap-2"},Me={class:"space-y-1"},Le={class:"text-base font-medium text-gray-900"},Oe={class:"space-y-1"},qe={class:"space-y-1"},Ge={class:"text-base text-gray-900 font-mono"},Je={class:"space-y-1"},Ke={class:"text-base text-gray-900"},Qe={class:"space-y-1"},Ye={class:"flex items-center gap-3"},Xe={key:0,class:"text-xs text-orange-700 ml-2"},Ze={key:0,class:"mt-3 flex items-center gap-3"},et={class:"space-y-1"},tt={class:"text-base text-gray-900"},at={class:"space-y-1 sm:col-span-2"},st={class:"text-base text-gray-900 whitespace-pre-line"},nt={key:0,class:"space-y-1 sm:col-span-2"},it={class:"flex flex-wrap gap-4"},ot=["src","alt"],ct=["src"],rt={key:2,class:"i-lucide-file text-3xl text-gray-400 mb-2"},lt=["href"],dt={class:"space-y-1"},ut={class:"text-base font-medium text-gray-900"},pt={class:"text-base text-gray-900"},mt={class:"text-base text-gray-900"},_t={class:"space-y-1"},ht={class:"text-base text-gray-900"},vt={class:"space-y-1 sm:col-span-2"},gt={class:"text-base text-gray-900 whitespace-pre-line"},ft={class:"sm:col-span-2 flex justify-end gap-3 pt-2"},Bt=Ue({__name:"[id]",async setup(C){let m,T;const x=Ae(),l=A(()=>x.params.id),d=f(!1),c=f(!1),p=Ie({status:"",priority:"",technicianId:""}),Z=["open","in_progress","pending","resolved","closed"],{data:t,status:ee,refresh:P,error:H}=([m,T]=K(()=>Y(()=>we(l.value),{watch:[l],server:!1},"$QR50sK36FS")),m=await m,T(),m),{data:I,error:yt,status:xt,refresh:te}=([m,T]=K(()=>Y("technicians",()=>$e(),{server:!1,lazy:!0,default:()=>[]})),m=await m,T(),m),ae=A(()=>(I.value||[]).map(a=>({label:a.username||a.email||`Tech #${a.id}`,value:String(a.id)}))),se=a=>{const e=a?.url||a?.path||a?.file_path||a?.attachment_url||a?.location;if(!e)return"";if(/^https?:\/\//i.test(e))return e;const _=window.location.origin.replace(/\/+$/,""),h=String(e).replace(/^\/+/,"");return h.startsWith("storage/")?`${_}/${h}`:h.startsWith("attachments/")?`${_}/storage/${h}`:h.startsWith("storage\\")?`${_}/${h.replace("\\","/")}`:`${_}/${h}`},M=A(()=>(t.value?.attachments||t.value?.files||t.value?.attachments?.data||t.value?.media||t.value?.documents||[]||[]).map(e=>({url:se(e),name:e?.name||e?.filename||e?.original_name||e?.file_name||e?.display_name||e?.path||e?.url||"File",type:e?.mime_type||e?.type||""})).filter(e=>e.url)),$=A(()=>{if(!t.value)return null;const a=t.value.assigned_tech_id||t.value.technician_id;return a?(I.value||[]).find(e=>e.id==a):null}),U=f(!1),S=f(null),L=f(null),O=f(!1),ne=A(()=>U.value&&S.value?S.value:$.value?.username||$.value?.email||t.value?.technician?.username||t.value?.technician?.name||t.value?.technician_name||"Unassigned"),q=async()=>{if(l.value)try{O.value=!0;const a=await fe(l.value);U.value=!!a?.is_pending,S.value=a?.technician_name??null,L.value=a?.technician_id??null}catch(a){console.error("Failed to load acceptance pending state",a),U.value=!1,S.value=null,L.value=null}finally{O.value=!1}},j=f(!1),B=f(!1),w=f(""),ie=async()=>{if(j.value=!0,!I.value||I.value.length===0)try{await te()}catch(e){console.error("Failed to load technicians",e)}const a=t.value?.assigned_tech_id||t.value?.technician_id||t.value?.technicianId||t.value?.technician?.id;w.value=a?String(a):""},oe=()=>{j.value=!1,w.value=""},ce=async()=>{if(l.value&&w.value){B.value=!0;try{const a=Number(w.value);console.log("About to send technician_id:",a),t.value?.assigned_tech_id||t.value?.technician_id?await Ee(l.value,a):await ze(l.value,a),await P(),j.value=!1}catch(a){console.error("Assign error",a)}finally{B.value=!1}}},F=f("");let V=null;const G=()=>{if(!t.value?.created_at)return;const a=new Date(t.value.created_at).getTime(),_=new Date().getTime()-a;if(_<0){F.value="0s";return}const h=Math.floor(_/(1e3*60*60*24)),D=Math.floor(_%(1e3*60*60*24)/(1e3*60*60)),g=Math.floor(_%(1e3*60*60)/(1e3*60)),z=Math.floor(_%(1e3*60)/1e3),k=[];h>0&&k.push(`${h}d`),D>0&&k.push(`${D}h`),g>0&&k.push(`${g}m`),k.push(`${z}s`),F.value=k.join(" ")};Se(()=>{G(),V=me(G,1e3)}),je(()=>{V&&clearInterval(V)}),De(()=>{if(t.value){p.status=t.value.status||"",p.priority=t.value.priority||"";const a=t.value.assigned_tech_id||t.value.technician_id||t.value.technicianId||t.value.technician?.id;p.technicianId=a?String(a):""}});const J=()=>{if(d.value=!d.value,!d.value&&t.value){p.status=t.value.status||"",p.priority=t.value.priority||"";const a=t.value.assigned_tech_id||t.value.technician_id||t.value.technicianId||t.value.technician?.id;p.technicianId=a?String(a):""}},re=async()=>{if(!(c.value||!l.value)){c.value=!0;try{const a={status:p.status||void 0,priority:p.priority||void 0,assigned_tech_id:p.technicianId?Number(p.technicianId):void 0};await Te(l.value,p.status),await P(),d.value=!1}catch(a){console.error("Failed to update ticket",a)}finally{c.value=!1}}};return Ne(()=>{P(),loadComments(),q()}),Pe(t,a=>{a&&loadComments(),a&&q()}),(a,e)=>{const _=he,h=ve,D=R("UDashboardPageHeader"),g=ye,z=ge,k=xe,E=R("UFormGroup"),le=ke,de=be,ue=R("UDashboardPage"),pe=_e;return v(),Q(pe,null,{default:u(()=>[o(_),o(ue,{class:"flex flex-col h-screen min-w-0"},{default:u(()=>[o(h,{title:"Ticket",icon:"i-lucide-ticket",class:"w-full"}),n("div",Re,[n("div",We,[o(D,{title:s(t)?`Ticket #${s(t).id}`:"Ticket",description:s(t)?.title||"Ticket details"},null,8,["title","description"]),n("div",He,[o(g,{size:"sm",icon:s(d)?"i-lucide-x":"i-lucide-pencil",color:s(d)?"neutral":"primary",onClick:J},{default:u(()=>[b(r(s(d)?"Cancel":"Edit"),1)]),_:1},8,["icon","color"]),o(g,{color:"neutral",variant:"ghost",icon:"i-lucide-arrow-left",to:"/supervisor/tickets"},{default:u(()=>[...e[2]||(e[2]=[b(" Back ",-1)])]),_:1})])]),o(le,{ui:{body:"grid gap-4 sm:grid-cols-2"},loading:s(ee)==="pending"},{default:u(()=>[s(d)?(v(),y(W,{key:1},[n("div",dt,[e[13]||(e[13]=n("p",{class:"text-xs text-muted-500"},"Title",-1)),n("p",ut,r(s(t)?.title||"-"),1)]),o(E,{label:"Status",name:"status"},{default:u(()=>[o(k,{modelValue:s(p).status,"onUpdate:modelValue":e[1]||(e[1]=i=>s(p).status=i),items:Z,placeholder:"Select status"},null,8,["modelValue"])]),_:1}),o(E,{label:"Priority",name:"priority"},{default:u(()=>[n("p",pt,r(s(t)?.priority||"-"),1)]),_:1}),o(E,{label:"Assign technician",name:"technician"},{default:u(()=>[n("p",mt,r(s($)?.username||s($)?.email||s(t)?.technician?.username||s(t)?.technician?.name||s(t)?.technician_name||"Unassigned"),1)]),_:1}),n("div",_t,[e[14]||(e[14]=n("p",{class:"text-xs text-muted-500"},"Category",-1)),n("p",ht,r(s(t)?.category?.name||"-"),1)]),n("div",vt,[e[15]||(e[15]=n("p",{class:"text-xs text-muted-500"},"Description",-1)),n("p",gt,r(s(t)?.description||"-"),1)]),n("div",ft,[o(g,{type:"button",color:"neutral",variant:"ghost",onClick:J},{default:u(()=>[...e[16]||(e[16]=[b("Cancel",-1)])]),_:1}),o(g,{type:"button",color:"primary",icon:"i-lucide-check",loading:s(c),disabled:s(c),onClick:re},{default:u(()=>[...e[17]||(e[17]=[b(" Save Changes ",-1)])]),_:1},8,["loading","disabled"])])],64)):(v(),y(W,{key:0},[n("div",Me,[e[3]||(e[3]=n("p",{class:"text-xs text-muted-500"},"Title",-1)),n("p",Le,r(s(t)?.title||"-"),1)]),n("div",Oe,[e[4]||(e[4]=n("p",{class:"text-xs text-muted-500"},"Status",-1)),o(z,{color:"primary",variant:"soft"},{default:u(()=>[b(r(s(t)?.status||"-"),1)]),_:1})]),n("div",qe,[e[5]||(e[5]=n("p",{class:"text-xs text-muted-500"},"Time Elapsed",-1)),n("p",Ge,r(s(F)),1)]),n("div",Je,[e[6]||(e[6]=n("p",{class:"text-xs text-muted-500"},"Priority",-1)),n("p",Ke,r(s(t)?.priority||"-"),1)]),n("div",Qe,[e[9]||(e[9]=n("p",{class:"text-xs text-muted-500"},"Technician",-1)),n("div",Ye,[n("p",{class:Be(["text-base",s(U)?"text-orange-600":"text-gray-900"])},r(s(ne)),3),s(U)?(v(),y("span",Xe,"(pending acceptance)")):N("",!0),o(g,{size:"sm",variant:"ghost",color:"primary",onClick:ie},{default:u(()=>[b(r(s($)||s(t)?.assigned_tech_id||s(t)?.technician_id?"Reassign":"Assign"),1)]),_:1})]),s(j)?(v(),y("div",Ze,[o(k,{modelValue:s(w),"onUpdate:modelValue":e[0]||(e[0]=i=>Fe(w)?w.value=i:null),items:s(ae),placeholder:"Choose technician"},null,8,["modelValue","items"]),o(g,{size:"sm",color:"primary",loading:s(B),onClick:ce},{default:u(()=>[...e[7]||(e[7]=[b("Confirm",-1)])]),_:1},8,["loading"]),o(g,{size:"sm",color:"neutral",variant:"ghost",onClick:oe},{default:u(()=>[...e[8]||(e[8]=[b("Cancel",-1)])]),_:1})])):N("",!0)]),n("div",et,[e[10]||(e[10]=n("p",{class:"text-xs text-muted-500"},"Category",-1)),n("p",tt,r(s(t)?.category?.name||"-"),1)]),n("div",at,[e[11]||(e[11]=n("p",{class:"text-xs text-muted-500"},"Description",-1)),n("p",st,r(s(t)?.description||"-"),1)]),s(M).length?(v(),y("div",nt,[e[12]||(e[12]=n("p",{class:"text-xs text-muted-500"},"Attachments",-1)),n("div",it,[(v(!0),y(W,null,Ve(s(M),i=>(v(),y("div",{key:i.url||i.name,class:"flex flex-col items-center w-32"},[i.url&&(i.url.endsWith(".png")||i.url.endsWith(".jpg")||i.url.endsWith(".jpeg")||i.url.endsWith(".gif"))?(v(),y("img",{key:0,src:i.url,alt:i.name,class:"w-28 h-28 object-cover rounded border"},null,8,ot)):i.url&&i.url.endsWith(".pdf")?(v(),y("embed",{key:1,src:i.url,type:"application/pdf",class:"w-28 h-28 border rounded"},null,8,ct)):(v(),y("span",rt)),n("a",{href:i.url,target:"_blank",class:"text-xs text-primary underline mt-1 break-all"},r(i.name||i.url),9,lt)]))),128))])])):N("",!0)],64))]),_:1},8,["loading"]),o(Ce,{"ticket-id":s(l)},null,8,["ticket-id"]),s(H)?(v(),Q(de,{key:0,icon:"i-lucide-alert-triangle",color:"red",variant:"soft",title:"Unable to load ticket",description:s(H)?.message||"Please try again."},null,8,["description"])):N("",!0)])]),_:1})]),_:1})}}});export{Bt as default};
