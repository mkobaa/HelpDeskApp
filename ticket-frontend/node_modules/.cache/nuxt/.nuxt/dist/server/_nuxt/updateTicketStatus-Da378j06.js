import { _ as _sfc_main$1 } from "./Card-o7xn3WFg.js";
import { _ as _sfc_main$2 } from "./Input-u_sFkXpR.js";
import { _ as _sfc_main$3 } from "./Select-Dv6KDMrI.js";
import { x as _sfc_main$4 } from "./usePortal-BKdXuyUd.js";
import { defineComponent, ref, computed, watch, resolveComponent, mergeProps, withCtx, createVNode, createTextVNode, createBlock, openBlock, Fragment, renderList, toDisplayString, createCommentVNode, useSSRContext } from "vue";
import { ssrRenderComponent, ssrRenderList, ssrInterpolate } from "vue/server-renderer";
import "/home/mkobaa/workspace/HelpDeskApp/ticket-frontend/node_modules/hookable/dist/index.mjs";
import { b as useCookie } from "../server.mjs";
import "./index-Db0gMLsE.js";
import "/home/mkobaa/workspace/HelpDeskApp/ticket-frontend/node_modules/defu/dist/defu.mjs";
import "#internal/nuxt/paths";
import "/home/mkobaa/workspace/HelpDeskApp/ticket-frontend/node_modules/klona/dist/index.mjs";
const getComments = async (ticketId) => {
  if (!ticketId) throw new Error("Ticket id is required");
  const token = useCookie("auth_token");
  let bearer = token.value || "";
  try {
    bearer = decodeURIComponent(bearer);
  } catch {
  }
  const url = `http://localhost:8000/api/tickets/${encodeURIComponent(ticketId)}/comments`;
  const response = await fetch(url, {
    method: "GET",
    headers: {
      Accept: "application/json",
      Authorization: `Bearer ${bearer}`
    }
  });
  const raw = await response.json();
  if (!response.ok) throw raw;
  return raw.data ?? raw;
};
const addComment = async (ticketId, payload) => {
  if (!ticketId) throw new Error("Ticket id is required");
  if (!payload) throw new Error("Comment payload is required");
  const token = useCookie("auth_token");
  let bearer = token.value || "";
  try {
    bearer = decodeURIComponent(bearer);
  } catch {
  }
  const url = `http://localhost:8000/api/tickets/${encodeURIComponent(ticketId)}/comments`;
  const response = await fetch(url, {
    method: "POST",
    headers: {
      Accept: "application/json",
      "Content-Type": "application/json",
      Authorization: `Bearer ${bearer}`
    },
    body: JSON.stringify(payload)
  });
  const raw = await response.json();
  if (!response.ok) throw raw;
  return raw.data ?? raw;
};
const _sfc_main = /* @__PURE__ */ defineComponent({
  __name: "TicketComments",
  __ssrInlineRender: true,
  props: {
    ticketId: {
      type: [String, Number],
      required: true
    }
  },
  setup(__props) {
    const props = __props;
    const comments = ref([]);
    const loading = ref(false);
    const newComment = ref("");
    const posting = ref(false);
    const isUserVisible = ref(true);
    const userRoleCookie = useCookie("user_role");
    const userRole = computed(() => String(userRoleCookie?.value || "").toLowerCase());
    const canSetVisibility = computed(() => ["supervisor", "technician"].includes(userRole.value));
    const load = async () => {
      if (!props.ticketId) return;
      loading.value = true;
      try {
        const data = await getComments(String(props.ticketId));
        comments.value = Array.isArray(data) ? data : data?.data || [];
      } catch (e) {
        console.error("Failed to load comments", e);
      } finally {
        loading.value = false;
      }
    };
    const postComment = async () => {
      if (!newComment.value || posting.value) return;
      posting.value = true;
      try {
        const payload = { content: newComment.value, is_user_visible: Boolean(isUserVisible.value) };
        const res = await addComment(String(props.ticketId), payload);
        const created = res?.data ? res.data : res;
        if (created) comments.value.unshift(created);
        newComment.value = "";
        isUserVisible.value = true;
      } catch (e) {
        console.error("Failed to post comment", e);
      } finally {
        posting.value = false;
      }
    };
    const formatDate = (iso) => new Date(iso).toLocaleString();
    watch(() => props.ticketId, () => load());
    return (_ctx, _push, _parent, _attrs) => {
      const _component_UCard = _sfc_main$1;
      const _component_UFormGroup = resolveComponent("UFormGroup");
      const _component_UInput = _sfc_main$2;
      const _component_USelect = _sfc_main$3;
      const _component_UButton = _sfc_main$4;
      _push(ssrRenderComponent(_component_UCard, mergeProps({ class: "mt-4" }, _attrs), {
        default: withCtx((_, _push2, _parent2, _scopeId) => {
          if (_push2) {
            _push2(`<div class="p-4"${_scopeId}><h3 class="text-lg font-semibold mb-3"${_scopeId}>Comments</h3><div class="space-y-3"${_scopeId}>`);
            if (loading.value) {
              _push2(`<div class="text-sm text-gray-500"${_scopeId}>Loading comments...</div>`);
            } else {
              _push2(`<div${_scopeId}><div class="space-y-3 max-h-80 overflow-y-auto pr-2"${_scopeId}>`);
              if (!comments.value.length) {
                _push2(`<div class="text-sm text-gray-500"${_scopeId}>No comments yet</div>`);
              } else {
                _push2(`<div class="space-y-3"${_scopeId}><!--[-->`);
                ssrRenderList(comments.value, (c) => {
                  _push2(`<div class="p-3 border rounded"${_scopeId}><div class="text-sm text-gray-800 whitespace-pre-line"${_scopeId}>${ssrInterpolate(c.content)}</div><div class="text-xs text-gray-400 mt-1"${_scopeId}>by ${ssrInterpolate(c.user_id ? `User #${c.username}` : c.user?.name || "Unknown")} • ${ssrInterpolate(c.created_at ? formatDate(c.created_at) : c.updated_at ? formatDate(c.updated_at) : "")}</div></div>`);
                });
                _push2(`<!--]--></div>`);
              }
              _push2(`</div></div>`);
            }
            _push2(`<div class="pt-2"${_scopeId}>`);
            _push2(ssrRenderComponent(_component_UFormGroup, {
              label: "Add comment",
              name: "comment"
            }, {
              default: withCtx((_2, _push3, _parent3, _scopeId2) => {
                if (_push3) {
                  _push3(ssrRenderComponent(_component_UInput, {
                    modelValue: newComment.value,
                    "onUpdate:modelValue": ($event) => newComment.value = $event,
                    placeholder: "Write a comment..."
                  }, null, _parent3, _scopeId2));
                } else {
                  return [
                    createVNode(_component_UInput, {
                      modelValue: newComment.value,
                      "onUpdate:modelValue": ($event) => newComment.value = $event,
                      placeholder: "Write a comment..."
                    }, null, 8, ["modelValue", "onUpdate:modelValue"])
                  ];
                }
              }),
              _: 1
            }, _parent2, _scopeId));
            if (canSetVisibility.value) {
              _push2(`<div class="mt-2"${_scopeId}>`);
              _push2(ssrRenderComponent(_component_UFormGroup, {
                label: "Visibility",
                name: "visibility"
              }, {
                default: withCtx((_2, _push3, _parent3, _scopeId2) => {
                  if (_push3) {
                    _push3(ssrRenderComponent(_component_USelect, {
                      modelValue: isUserVisible.value,
                      "onUpdate:modelValue": ($event) => isUserVisible.value = $event,
                      items: [{ label: "Public", value: true }, { label: "Private", value: false }]
                    }, null, _parent3, _scopeId2));
                  } else {
                    return [
                      createVNode(_component_USelect, {
                        modelValue: isUserVisible.value,
                        "onUpdate:modelValue": ($event) => isUserVisible.value = $event,
                        items: [{ label: "Public", value: true }, { label: "Private", value: false }]
                      }, null, 8, ["modelValue", "onUpdate:modelValue"])
                    ];
                  }
                }),
                _: 1
              }, _parent2, _scopeId));
              _push2(`</div>`);
            } else {
              _push2(`<!---->`);
            }
            _push2(`<div class="flex justify-end gap-2 mt-2"${_scopeId}>`);
            _push2(ssrRenderComponent(_component_UButton, {
              size: "sm",
              color: "neutral",
              variant: "ghost",
              onClick: ($event) => newComment.value = ""
            }, {
              default: withCtx((_2, _push3, _parent3, _scopeId2) => {
                if (_push3) {
                  _push3(`Cancel`);
                } else {
                  return [
                    createTextVNode("Cancel")
                  ];
                }
              }),
              _: 1
            }, _parent2, _scopeId));
            _push2(ssrRenderComponent(_component_UButton, {
              size: "sm",
              color: "primary",
              loading: posting.value,
              onClick: postComment
            }, {
              default: withCtx((_2, _push3, _parent3, _scopeId2) => {
                if (_push3) {
                  _push3(`Post`);
                } else {
                  return [
                    createTextVNode("Post")
                  ];
                }
              }),
              _: 1
            }, _parent2, _scopeId));
            _push2(`</div></div></div></div>`);
          } else {
            return [
              createVNode("div", { class: "p-4" }, [
                createVNode("h3", { class: "text-lg font-semibold mb-3" }, "Comments"),
                createVNode("div", { class: "space-y-3" }, [
                  loading.value ? (openBlock(), createBlock("div", {
                    key: 0,
                    class: "text-sm text-gray-500"
                  }, "Loading comments...")) : (openBlock(), createBlock("div", { key: 1 }, [
                    createVNode("div", { class: "space-y-3 max-h-80 overflow-y-auto pr-2" }, [
                      !comments.value.length ? (openBlock(), createBlock("div", {
                        key: 0,
                        class: "text-sm text-gray-500"
                      }, "No comments yet")) : (openBlock(), createBlock("div", {
                        key: 1,
                        class: "space-y-3"
                      }, [
                        (openBlock(true), createBlock(Fragment, null, renderList(comments.value, (c) => {
                          return openBlock(), createBlock("div", {
                            key: c.id,
                            class: "p-3 border rounded"
                          }, [
                            createVNode("div", { class: "text-sm text-gray-800 whitespace-pre-line" }, toDisplayString(c.content), 1),
                            createVNode("div", { class: "text-xs text-gray-400 mt-1" }, "by " + toDisplayString(c.user_id ? `User #${c.username}` : c.user?.name || "Unknown") + " • " + toDisplayString(c.created_at ? formatDate(c.created_at) : c.updated_at ? formatDate(c.updated_at) : ""), 1)
                          ]);
                        }), 128))
                      ]))
                    ])
                  ])),
                  createVNode("div", { class: "pt-2" }, [
                    createVNode(_component_UFormGroup, {
                      label: "Add comment",
                      name: "comment"
                    }, {
                      default: withCtx(() => [
                        createVNode(_component_UInput, {
                          modelValue: newComment.value,
                          "onUpdate:modelValue": ($event) => newComment.value = $event,
                          placeholder: "Write a comment..."
                        }, null, 8, ["modelValue", "onUpdate:modelValue"])
                      ]),
                      _: 1
                    }),
                    canSetVisibility.value ? (openBlock(), createBlock("div", {
                      key: 0,
                      class: "mt-2"
                    }, [
                      createVNode(_component_UFormGroup, {
                        label: "Visibility",
                        name: "visibility"
                      }, {
                        default: withCtx(() => [
                          createVNode(_component_USelect, {
                            modelValue: isUserVisible.value,
                            "onUpdate:modelValue": ($event) => isUserVisible.value = $event,
                            items: [{ label: "Public", value: true }, { label: "Private", value: false }]
                          }, null, 8, ["modelValue", "onUpdate:modelValue"])
                        ]),
                        _: 1
                      })
                    ])) : createCommentVNode("", true),
                    createVNode("div", { class: "flex justify-end gap-2 mt-2" }, [
                      createVNode(_component_UButton, {
                        size: "sm",
                        color: "neutral",
                        variant: "ghost",
                        onClick: ($event) => newComment.value = ""
                      }, {
                        default: withCtx(() => [
                          createTextVNode("Cancel")
                        ]),
                        _: 1
                      }, 8, ["onClick"]),
                      createVNode(_component_UButton, {
                        size: "sm",
                        color: "primary",
                        loading: posting.value,
                        onClick: postComment
                      }, {
                        default: withCtx(() => [
                          createTextVNode("Post")
                        ]),
                        _: 1
                      }, 8, ["loading"])
                    ])
                  ])
                ])
              ])
            ];
          }
        }),
        _: 1
      }, _parent));
    };
  }
});
const _sfc_setup = _sfc_main.setup;
_sfc_main.setup = (props, ctx) => {
  const ssrContext = useSSRContext();
  (ssrContext.modules || (ssrContext.modules = /* @__PURE__ */ new Set())).add("components/TicketComments.vue");
  return _sfc_setup ? _sfc_setup(props, ctx) : void 0;
};
const __nuxt_component_7 = Object.assign(_sfc_main, { __name: "TicketComments" });
const updateTicketStatus = async (id, status) => {
  if (!id) throw new Error("Ticket id is required");
  if (!status) throw new Error("Status is required");
  const token = useCookie("auth_token");
  let bearer = token.value || "";
  try {
    bearer = decodeURIComponent(bearer);
  } catch {
  }
  const url = `http://localhost:8000/api/tickets/${encodeURIComponent(id)}/status`;
  const response = await fetch(url, {
    method: "PUT",
    headers: {
      Accept: "application/json",
      "Content-Type": "application/json",
      Authorization: `Bearer ${bearer}`
    },
    body: JSON.stringify({ status })
  });
  const raw = await response.json();
  if (!response.ok) {
    throw raw;
  }
  if (raw?.data) return raw.data;
  return raw;
};
export {
  __nuxt_component_7 as _,
  updateTicketStatus as u
};
//# sourceMappingURL=updateTicketStatus-Da378j06.js.map
